namespace = flavor_burgundy_prologue

# Event 1: The Plague of 1361 - Succession Crisis
flavor_burgundy_prologue.1 = {
	type = country_event
	title = flavor_burgundy_prologue.1.t
	desc = flavor_burgundy_prologue.1.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1361.1.1
		current_date < 1362.1.1
		is_subject_of = c:FRA
		any_owned_province = {
			has_province_modifier = plague
		}
	}

	immediate = {
		hidden_effect = {
			set_variable = burgundy_succession_crisis
			c:FRA = {
				save_scope_as = french_overlord
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.a
		ai_chance = { base = 75 }
		
		# The duchy legally reverts to France
		custom_description = {
			text = flavor_burgundy_prologue.1.a.tooltip
			c:FRA = {
				inherit = root
			}
		}
		
		# Trigger immediate follow-up for player swap
		if = {
			limit = { is_human = yes }
			trigger_event = { id = flavor_burgundy_prologue.2 days = 1 }
		}
		else = {
			# AI stays as France
			hidden_effect = {
				c:FRA = {
					set_country_flag = burgundy_inherited_from_capetians
				}
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.b
		ai_chance = { base = 25 }
		
		# Reject French overlordship
		trigger_event = { id = flavor_burgundy_prologue.1.b.follow_up days = 5 }
	}
}

# Follow-up to Event 1 Option B: Rebellion and Reconquest
flavor_burgundy_prologue.1.b.follow_up = {
	type = country_event
	title = flavor_burgundy_prologue.1.b.title
	desc = flavor_burgundy_prologue.1.b.desc
	fire_only_once = yes

	immediate = {
		hidden_effect = {
			# Break subject status
			end_subject_relationship = c:FRA
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.b.a
		
		add_opinion = { target = c:FRA value = -150 }
		c:FRA = {
			add_casus_belli = { target = root type = casus_belli:cb_conquest }
		}
		
		# Spawn large rebel force in capital
		capital = {
			spawn_rebellion = {
				size = 4
				rebels = loyalist_rebels
			}
		}
		
		# War taxes due to crisis
		add_country_modifier = { name = succession_crisis_modifier duration = 3650 }
	}
}

# Event 2: The Gift of King Jean - Valois Dynasty Granted (Fires immediately after Event 1.a)
flavor_burgundy_prologue.2 = {
	type = country_event
	title = flavor_burgundy_prologue.2.t
	desc = flavor_burgundy_prologue.2.d
	fire_only_once = yes
	is_triggered_only = yes

	immediate = {
		hidden_effect = {
			# Release and recreate BUR as a new country
			if = {
				limit = { tag = FRA }
				release_subject = {
					country = BUR
					release_base_nation = yes
				}
			}
			
			# Set to released BUR if player was France
			if = {
				limit = { is_human = yes }
				switch_to_country = c:BUR
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.2.a
		
		# Set Valois dynasty
		set_primary_culture = frankish
		change_country_name = "Burgundy (Valois)"
		
		# Define Philip the Bold as ruler
		define_ruler = {
			name = "Philip"
			dynasty = "Valois"
			birth_date = 1342.1.15
			adm = 4
			dip = 5
			mil = 5
			personality = careful_personality
			personality = charismatic_personality
		}
		
		# Define John the Fearless as heir
		define_heir = {
			name = "John"
			dynasty = "Valois"
			birth_date = 1371.5.13
			adm = 4
			dip = 4
			mil = 5
			personality = ambitious_personality
		}
		
		# Grant loyalty modifier as French appanage
		add_country_modifier = {
			name = loyal_appanage
			duration = 7300
		}
		
		# Improve relations with overlord
		add_opinion = { target = c:FRA value = 150 }
		
		# Set flag for later event chain (Golden Age in 1384)
		set_country_flag = valois_dynasty_established
	}
}

# Event 3: The Wedding in Ghent (1369) - Securing Flanders Alliance
flavor_burgundy_prologue.3 = {
	type = country_event
	title = flavor_burgundy_prologue.3.t
	desc = flavor_burgundy_prologue.3.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1369.1.1
		current_date < 1370.1.1
		c:FLA = { exists = yes }
		has_country_flag = valois_dynasty_established
		OR = {
			ruler = {
				name = "Philip"
				dynasty = "Valois"
			}
			has_ruler_flag = philip_the_bold
		}
	}

	immediate = {
		hidden_effect = {
			c:FLA = {
				save_scope_as = flanders_ally
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.3.a
		
		# Form marriage alliance with Flanders
		if = {
			limit = { c:FLA = { exists = yes } }
			create_marriage = c:FLA
		}
		
		# Set crucial flag for future Low Countries acquisition
		set_country_flag = burgundian_succession_secured
		
		# Administrative reward representing Flanders influence
		add_ruler_modifier = {
			modifier = flanders_marriage_alliance
			years = 15
		}
		
		# Diplomatic bonus
		add_opinion = { target = c:FLA value = 100 }
		
		# Hidden flag for event chain dependency
		hidden_effect = {
			set_variable = {
				name = prologue_events_complete
				value = 1
			}
		}
	}
}
