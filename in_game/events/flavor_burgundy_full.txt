namespace = flavor_burgundy

######################################
# PROLOGUE EVENT CHAIN (1361-1369)
# Capetian to Valois Transition
######################################

# Prologue Event 1: The Plague of 1361 - Succession Crisis
flavor_burgundy_prologue.1 = {
	type = country_event
	title = flavor_burgundy_prologue.1.t
	desc = flavor_burgundy_prologue.1.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1361.1.1
		current_date < 1362.1.1
		is_subject_of = c:FRA
		any_owned_province = {
			has_province_modifier = plague
		}
	}

	immediate = {
		hidden_effect = {
			set_variable = burgundy_succession_crisis
			c:FRA = {
				save_scope_as = french_overlord
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.a
		ai_chance = { base = 75 }
		
		# The duchy legally reverts to France
		custom_description = {
			text = flavor_burgundy_prologue.1.a.tooltip
			c:FRA = {
				inherit = root
			}
		}
		
		# Trigger immediate follow-up for player swap
		if = {
			limit = { is_human = yes }
			trigger_event = { id = flavor_burgundy_prologue.2 days = 1 }
		}
		else = {
			# AI stays as France
			hidden_effect = {
				c:FRA = {
					set_country_flag = burgundy_inherited_from_capetians
				}
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.b
		ai_chance = { base = 25 }
		
		# Reject French overlordship
		trigger_event = { id = flavor_burgundy_prologue.1.b.follow_up days = 5 }
	}
}

# Prologue Follow-up to Event 1 Option B: Rebellion and Reconquest
flavor_burgundy_prologue.1.b.follow_up = {
	type = country_event
	title = flavor_burgundy_prologue.1.b.title
	desc = flavor_burgundy_prologue.1.b.desc
	fire_only_once = yes

	immediate = {
		hidden_effect = {
			# Break subject status
			end_subject_relationship = c:FRA
		}
	}

	option = {
		name = flavor_burgundy_prologue.1.b.a
		
		add_opinion = { target = c:FRA value = -150 }
		c:FRA = {
			add_casus_belli = { target = root type = casus_belli:cb_conquest }
		}
		
		# War taxes due to crisis
		add_country_modifier = { name = succession_crisis_modifier duration = 3650 }
	}
}

# Prologue Event 2: The Gift of King Jean - Valois Dynasty Granted
flavor_burgundy_prologue.2 = {
	type = country_event
	title = flavor_burgundy_prologue.2.t
	desc = flavor_burgundy_prologue.2.d
	fire_only_once = yes
	is_triggered_only = yes

	immediate = {
		hidden_effect = {
			# This event should fire for BUR after being recreated as French subject
			# The inheritance in prologue.1 transfers to France, then France should recreate BUR via setup or manual release
			# For gameplay purposes, this event represents BUR receiving its new Valois dynasty
		}
	}

	option = {
		name = flavor_burgundy_prologue.2.a
		
		# Create Philip the Bold as ruler via character creation
		create_character = {
			name = "Philip"
			dynasty = Valois
			birth_date = 1342.1.15
			adm = 4
			dip = 5
			mil = 5
			random_traits = no
		}
		
		# Create John the Fearless as a character (not direct heir, will need succession setup)
		create_character = {
			name = "John"
			dynasty = Valois
			birth_date = 1371.5.13
			adm = 4
			dip = 4
			mil = 5
			random_traits = no
		}
		
		# Grant loyalty modifier as French appanage
		add_country_modifier = {
			name = loyal_appanage
			duration = 7300
		}
		
		# Improve relations with overlord
		add_opinion = { target = c:FRA value = 150 }
		
		# Set flag for later event chain
		set_country_flag = valois_dynasty_established
	}
}

# Prologue Event 3: The Wedding in Ghent (1369) - Securing Flanders Alliance
flavor_burgundy_prologue.3 = {
	type = country_event
	title = flavor_burgundy_prologue.3.t
	desc = flavor_burgundy_prologue.3.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1369.1.1
		current_date < 1370.1.1
		has_country_flag = valois_dynasty_established
	}

	immediate = {
		hidden_effect = {
			if = {
				limit = { c:FLA = { exists = yes } }
				c:FLA = {
					save_scope_as = flanders_ally
				}
			}
		}
	}

	option = {
		name = flavor_burgundy_prologue.3.a
		
		# Form marriage alliance with Flanders
		if = {
			limit = { c:FLA = { exists = yes } }
			create_marriage = c:FLA
		}
		
		# Set crucial flag for future Low Countries acquisition
		set_country_flag = burgundian_succession_secured
		
		# Administrative reward representing Flanders influence
		add_country_modifier = {
			name = flanders_marriage_alliance
			duration = 5475
		}
		
		# Diplomatic bonus
		if = {
			limit = { c:FLA = { exists = yes } }
			add_opinion = { target = c:FLA value = 100 }
		}
		
		# Hidden flag for event chain dependency
		hidden_effect = {
			set_variable = {
				name = prologue_events_complete
				value = 1
			}
		}
	}
}

######################################
# MAIN EVENT CHAIN (1380-1550)
# Burgundy's Golden Age to Spanish Split
######################################

# Phase I - The Golden Age (1380+)
flavor_burgundy.1 = {
	type = country_event
	title = flavor_burgundy.1.t
	desc = flavor_burgundy.1.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1380.1.1
		OR = {
			any_owned_province = { region = region:low_countries_region }
			any_subject_country = { any_owned_province = { region = region:low_countries_region } }
		}
	}

	option = {
		name = flavor_burgundy.1.a
		add_country_modifier = { name = middle_kingdom_diplomacy duration = 18250 }
		if = {
			limit = { c:FRA = { exists = yes is_rival_of = root } }
			add_opinion = { target = c:ENG value = 100 }
		}
	}
}

# Phase I follow-up - Connecting the Lands (1460+)
flavor_burgundy.2 = {
	type = country_event
	title = flavor_burgundy.2.t
	desc = flavor_burgundy.2.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1460.1.1
	}

	option = {
		name = flavor_burgundy.2.a
		add_casus_belli = { target = c:LOR type = casus_belli:cb_conquest }
		every_location = {
			limit = { region = region:lorraine_region }
			add_core = root
		}
		add_country_modifier = { name = burgundy_war_taxes duration = 3650 }
	}
}

# Phase II - The Catastrophe of 1477
flavor_burgundy.10 = {
	type = country_event
	title = flavor_burgundy.10.t
	desc = flavor_burgundy.10.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1477.1.1
		any_owned_province = { region = region:france_region }
	}

	immediate = {
		if = {
			limit = { c:FRA = { exists = yes } }
			every_owned_province = {
				limit = { region = region:france_region }
				change_location_owner = c:FRA
			}
		}
		if = {
			limit = { capital = { region = region:france_region } }
			random_owned_province = {
				limit = { region = region:low_countries_region is_capital = no }
				set_capital = THIS
			}
		}
	}

	option = {
		name = flavor_burgundy.10.a
		if = {
			limit = { c:HAB = { exists = yes } }
			make_subject_of = { target = c:HAB type = subject_type:personal_union }
		}
		add_country_modifier = { name = imperial_protection duration = 3650 }
	}

	option = {
		name = flavor_burgundy.10.b
		add_opinion = { target = c:FRA value = -150 }
		add_opinion = { target = c:HAB value = -150 }
	}
}

# Phase III - The Burgundian Circle (1500+)
flavor_burgundy.20 = {
	type = country_event
	title = flavor_burgundy.20.t
	desc = flavor_burgundy.20.d
	fire_only_once = yes

	trigger = {
		tag = BUR
		current_date >= 1500.1.1
		any_owned_province = { region = region:low_countries_region }
	}

	option = {
		name = flavor_burgundy.20.a
		add_country_modifier = { name = burgundy_pragmatic_sanction duration = -1 }
		every_owned_province = {
			limit = { region = region:low_countries_region }
			add_province_modifier = { name = burgundian_circle duration = -1 }
		}
	}
}

# Phase IV - The Spanish Split (1550+)
flavor_burgundy.30 = {
	type = country_event
	title = flavor_burgundy.30.t
	desc = flavor_burgundy.30.d
	fire_only_once = yes

	trigger = {
		current_date >= 1550.1.1
		any_owned_province = { region = region:low_countries_region }
		is_great_power = yes
	}

	option = {
		name = flavor_burgundy.30.a
		if = {
			limit = { c:SPA = { exists = yes } }
			make_subject_of = { target = c:SPA type = subject_type:personal_union }
		}
		set_country_flag = dutch_revolt_brewing
	}
}
